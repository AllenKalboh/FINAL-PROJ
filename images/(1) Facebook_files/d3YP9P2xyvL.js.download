;/*FB_PKG_DELIM*/

__d("LSFetchOTCEligibleEBDevicesV2",["LSIssueNewEbTaskAndGetTaskIDV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return c.forEach(c.db.table(261).fetch(),function(a){return a["delete"]()})},function(a){return d[0]="",c.forEach(c.filter(c.db.table(261).fetch([[[d[0]]]]),function(a){return a.deviceId===d[0]&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(261).add({deviceId:d[0],authorityLevel:c.i64.cast([0,20])})},function(a){return d[1]=new c.Map(),d[2]=c.toJSON(d[1]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_fetch_otc_eligible_devices",c.i64.cast([0,50028]),d[2],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[3]=a[0],a})}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsFetchOTCEligibleEBDevicesV2StoredProcedure";e.exports=a}),null);
__d("LSFetchOTCEligibleEBDevicesV2StoredProcedure",["LSFetchOTCEligibleEBDevicesV2","cr:8709"],(function(a,b,c,d,e,f,g){function a(a){return c("LSFetchOTCEligibleEBDevicesV2")(a)}g["default"]=a}),98);
__d("MWChatEncryptedBackupsAutoRestoreConsentStepDeferred.react",["deferredLoadComponent","react","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h||d("react"),j=c("deferredLoadComponent")(c("requireDeferred")("MWChatEncryptedBackupsAutoRestoreConsentStep.react").__setRef("MWChatEncryptedBackupsAutoRestoreConsentStepDeferred.react"));function a(a){return i.jsx(j,babelHelpers["extends"]({},a))}a.displayName=a.name+" [from "+f.id+"]";g["default"]=a}),98);
__d("MWEBQPOneTimeCode.react",["ix","CometImageFromIXValue.react","gkx","react"],(function(a,b,c,d,e,f,g,h){"use strict";var i,j=i||d("react"),k=c("gkx")("23433");b=j.forwardRef(a);function a(a,b){var d=a.alt;a=a.xstyle;var e=k?h("421460"):h("421458");return j.jsx(c("CometImageFromIXValue.react"),{alt:d,ref:b,source:e,xstyle:a})}a.displayName=a.name+" [from "+f.id+"]";e=b;g["default"]=e}),98);
__d("PAKEClientTypeEnum",[],(function(a,b,c,d,e,f){a=Object.freeze({PAKE_TEST:-1,ENCRYPTED_BACKUPS:0});f["default"]=a}),66);
__d("useFetchOTCEligibleEBDevices",["FBLogger","LSAuthorityLevel","LSFactory","LSFetchOTCEligibleEBDevicesV2StoredProcedure","LSIntEnum","ReQL","ReQLSuspense","gkx","promiseDone","react","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;b=j||d("react");var k=b.useCallback,l=b.useEffect,m=b.useRef,n=b.useState,o=c("gkx")("24064");function a(){var a=(h||(h=c("useReStore")))(),b=m(!1),e=n(!1),g=e[0],j=e[1];e=n(!1);var p=e[0],q=e[1];e=n(!1);var r=e[0],s=e[1];e=n(!1);var t=e[0],u=e[1];e=n([]);var v=e[0],w=e[1],x=d("ReQLSuspense").useArray(function(){return g?d("ReQL").fromTableAscending(a.tables.encrypted_backups_otc_devices):d("ReQL").empty()},[g,a],f.id+":49"),y=k(function(){return a.runInTransaction(function(a){return c("LSFetchOTCEligibleEBDevicesV2StoredProcedure")(c("LSFactory")(a))},"readwrite",void 0,void 0,f.id+":58")},[a]),z=k(function(){q(!0),s(!1),c("promiseDone")(y(),function(){j(!0)},function(){c("FBLogger")("labyrinth_web").mustfix("Failed to fetch OTC eligible devices")})},[y]);l(function(){if(b.current!==!0)b.current=!0,z();else if(g){var a=x.length>0&&(i||(i=d("LSIntEnum"))).toNumber(x[0].authorityLevel)===c("LSAuthorityLevel").OPTIMISTIC;if(!a){q(!1);j(!1);a=x[0];a=a.deviceId==="-1";if(a){s(!0);c("FBLogger")("labyrinth_web").mustfix("Encrypted Backups OTC: Failed to fetch otc eligible devices.");return}a=x.filter(function(a){return(i||(i=d("LSIntEnum"))).toNumber(a.authorityLevel)!==c("LSAuthorityLevel").OPTIMISTIC&&a.deviceId!==""});w(a);u(a.length>0||o)}}},[y,g,x,z]);return{doesUserHaveOtcEligibleDevices:t,failedToFetchOtcDevices:r,isFetchOtcDevicesInFlight:p,otcEligibleDevices:v,triggerFetchOtcEligibleDevices:z}}g["default"]=a}),98);
__d("usePakeInitiatorManager",["FBLogger","PakeCpaceWasm","Promise","asyncToGeneratorRuntime","promiseDone","react","requireDeferred","useAsyncReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i;e=i||d("react");var j=e.useCallback,k=e.useEffect,l=e.useRef,m=c("requireDeferred")("establishPakeHandshakeAsInitiator").__setRef("usePakeInitiatorManager"),n=3e4;function a(a){var e=a.onGeneralFailure,f=a.onMaxAttemptsReached,g=a.onNoSessionExists,i=a.onSessionExpired,o=a.onSuccessfulSecretDecryption,p=a.onWrongOtc,q=a.timeout,r=q===void 0?n:q,s=a.clientType,t=c("useAsyncReStore")(),u=l(null),v=l(function(){}),w=l(function(){}),x=l(null),y=l(!1);k(function(){y.current===!1&&(y.current=!0,c("promiseDone")(d("PakeCpaceWasm").PakeCPaceWasm().then(function(a){x.current=a}),void 0,function(){c("FBLogger")("labyrinth_web").mustfix("PAKE: Error loading WASM module")}));return function(){var a;w.current();(a=u.current)==null?void 0:a["delete"]();v.current()}},[]);return{establishPakeHandshakeAsInitiator:j(function(a){return(h||(h=b("Promise"))).all([t,m.load()]).then(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=b[0];b=b[1];b=(yield b({clientType:s,onGeneralFailure:e,onMaxAttemptsReached:f,onNoSessionExists:g,onSessionExpired:i,onSuccessfulSecretDecryption:o,onWrongOtc:p,otc:a,pakeCpaceModule:x.current,storage:c,timeout:r}));c=b.pakeClient;var d=b.stopTimeout;b=b.unsubFromMessagesTable;u.current=c;v.current=d;w.current=b});return function(a){return c.apply(this,arguments)}}())},[s,t,e,f,g,i,o,p,r])}}g["default"]=a}),98);
__d("MWEncryptedBackupsInsertOTCStep.react",["fbt","EBSMGating","FBLogger","FocusRegion.react","JSResourceForInteraction","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsNumericCodeErrorWrapper.react","MWChatEncryptedBackupsNumericCodeInput.react","MWChatEncryptedBackupsQPLEvents","MWChatEncryptedBackupsSetIsDialogPersistedContext","MWEBQPOneTimeCode.react","MWEncryptedBackupsLocalStorageEntryEnum","MWEncryptedBackupsOTCEligibleDevicesContext.react","MWXColumn.react","MWXColumnItem.react","MWXDialogPageLegacy.react","MWXLink.react","MWXMultiStepDialogHeader.react","MWXRow.react","MWXRowItem.react","MWXSpinner.react","MWXText.react","PAKEClientTypeEnum","QPLUserFlow","focusScopeQueries","gkx","promiseDone","react","requireDeferred","useFetchOTCEligibleEBDevices","useMWChatEncryptedBackupsNumericCode","useMWEBFlowSourceContext","usePakeInitiatorManager","useReStore","useVisibilityObserver"],(function(a,b,c,d,e,f,g,h){"use strict";var i,j,k=j||(j=d("react"));b=j;var l=b.useCallback,m=b.useContext,n=b.useEffect,o=b.useRef,p=b.useState,q=c("requireDeferred")("MWEBUseLocalStorage").__setRef("MWEncryptedBackupsInsertOTCStep.react"),r=c("requireDeferred")("MWEncrypedBackupsSendOTCNotifications").__setRef("MWEncryptedBackupsInsertOTCStep.react"),s=c("requireDeferred")("MWEncryptedBackupsFetchBackupIds").__setRef("MWEncryptedBackupsInsertOTCStep.react"),t=c("requireDeferred")("MWEncryptedBackupsSharedState").__setRef("MWEncryptedBackupsInsertOTCStep.react"),u=c("requireDeferred")("deserializeSecretsAndAddDevice").__setRef("MWEncryptedBackupsInsertOTCStep.react"),v=c("JSResourceForInteraction")("MWEBPushResetPinPage").__setRef("MWEncryptedBackupsInsertOTCStep.react"),w="chat-encrypted-backups-dialog-layout-second-step",x=6,y=c("gkx")("23219"),z=c("gkx")("20861"),A=function(){return h._("__JHASH__lBlURV9iIv0__JHASH__")},B=function(){return h._("__JHASH__rIH_-tfv2x2__JHASH__")},C=function(){return h._("__JHASH__WypD50Gdi03__JHASH__")},D=function(){return h._("__JHASH__7uRJ4wtXcoz__JHASH__")},E=function(){return h._("__JHASH__XUu1h3R4qPj__JHASH__")},F=function(){return h._("__JHASH__ndaWq552FSK__JHASH__")},G=function(){return h._("__JHASH__WoNRZZnIdhP__JHASH__")};function a(a){var b=a.onComplete,e=a.onViewAllDevices;a=p(!1);var f=a[0],g=a[1],j=o(!1),H=o(!1),I=o(function(){}),J=o(function(){});a=p(null);var K=a[0],L=a[1],M=(i||(i=c("useReStore")))();a=c("useFetchOTCEligibleEBDevices")();var N=a.failedToFetchOtcDevices,O=a.isFetchOtcDevicesInFlight,P=a.otcEligibleDevices,Q=a.triggerFetchOtcEligibleDevices;a=m(d("MWEncryptedBackupsOTCEligibleDevicesContext.react").MWEncryptedBackupsOTCEligibleDevicesContext);var R=a.setFailedToFetchOtcDevices,S=a.setIsFetchOtcDevicesInFlight,T=a.setOtcEligibleDevices,U=c("useMWEBFlowSourceContext")(),V=m(c("MWChatEncryptedBackupsSetIsDialogPersistedContext")).setIsDialogPersisted;n(function(){return function(){I.current(),J.current()}},[]);n(function(){j.current===!1&&(j.current=!0,c("promiseDone")(v.load()),r.onReady(function(a){a=a.sendOTCNotifications;c("promiseDone")(a({db:M,onFailure:function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_SEND_NOTIFICATION_FAILURE"),L(F())},otcEligibleDevices:[]}),function(a){I.current=a},function(){c("FBLogger")("labyrinth_web").mustfix("OTC: Send otc notifications sproc failed."),c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_SEND_NOTIFICATION_FAILURE"),L(F())})})),S(O),T(P),R(N)},[M,N,O,P,R,S,T]);a=c("usePakeInitiatorManager")({clientType:c("PAKEClientTypeEnum").ENCRYPTED_BACKUPS,onGeneralFailure:l(function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_API_FAILURE"),L(E()),H.current=!0,g(!1),V==null?void 0:V(!1)},[V]),onMaxAttemptsReached:l(function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_MAX_ATTEMPTS_REACHED"),L(C()),H.current=!0,g(!1)},[]),onNoSessionExists:l(function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_NO_SESSION"),L(B()),H.current=!0,g(!1)},[]),onSessionExpired:l(function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_SESSION_EXPIRED"),L(D()),H.current=!0,g(!1)},[]),onSuccessfulSecretDecryption:l(function(a){var e=a.decryptedSecret,f=a.initiatorId;V==null?void 0:V(!0);c("promiseDone")(u.load(),function(a){c("promiseDone")(a({db:M,initiatorId:f,onAddDeviceFailure:function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_ADD_DEVICE_FAILURE"),L(E()),H.current=!0,g(!1),V==null?void 0:V(!1)},onAddDeviceFinish:function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_ADD_DEVICE_FINISHED"),d("MWChatEncryptedBackupsLogging").endSuccess({annotations:{bool:{is_backend_setup:d("EBSMGating").isBackendSetupSuccessfulForEBSM()}},event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),t.onReady(function(a){a=a.upsertEBSharedStateEntry;c("promiseDone")(a({db:M,stateKey:c("MWEncryptedBackupsLocalStorageEntryEnum").ENCRYPTED_BACKUPS_RESTORED_SUCCESSFULLY}))}),q.onReady(function(a){var b=a.mwEBCreateLocalStorageEntry;a=a.mwEBDeleteLocalStorageEntry;b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION);b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION_2);a(c("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE)}),b(),g(!1),s.onReady(function(a){a=a.encryptedBackupsFetchBackupIds;a(M)["catch"](function(a){return c("FBLogger")("labyrinth_web").mustfix("OTC Restore: Error when fetching backup ids, %s",a)})})},secrets:e}),function(a){J.current=a})})},[M,b,V]),onWrongOtc:l(function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_INCORRECT_CODE"),L(A()),H.current=!0,g(!1)},[])});var W=a.establishPakeHandshakeAsInitiator;a=d("useMWChatEncryptedBackupsNumericCode").useMWChatEncryptedBackupsNumericCode({focusRegionId:w,inputSize:x,onChange:function(){L()},onComplete:function(a){var b=U();c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{restore_type:"one_time_code",source:b}});g(!0);c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_SUBMIT");c("promiseDone")(W(a))}});var X=a[0];a=a[1];var Y=a.clearNumericInput,Z=a.focusOnInput;a=a.isLoading;n(function(){H.current&&(Y(),H.current=!1)},[Y]);var $=c("useVisibilityObserver")({onVisible:function(){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_SCREEN"),Z()}}),aa=h._("__JHASH__mdY4-jjsr2I__JHASH__");return k.jsxs(k.Fragment,{children:[k.jsx(c("MWXMultiStepDialogHeader.react"),{withCloseButton:!1,withoutBackButton:!0,withoutHeaderBottomBorder:!0}),k.jsx(c("MWXDialogPageLegacy.react"),{callToActionGroupLayout:"expanded",includeFDSContentPadding_REMOVE_THIS_AFTER_CONTENT_PADDING_MIGRATION:!1,ref:$,children:k.jsx("div",{className:"x2lwn1j",children:k.jsxs(c("MWXColumn.react"),{align:"center",paddingHorizontal:16,paddingVertical:16,spacing:8,children:[k.jsx(c("MWXColumnItem.react"),{align:"center",paddingTop:16,children:k.jsx("div",{className:"xg87l8a",children:k.jsx(c("MWEBQPOneTimeCode.react"),{})})}),k.jsx(c("MWXColumnItem.react"),{align:"center",paddingVertical:16,children:k.jsx(c("MWXText.react"),{align:"center",type:"headlineEmphasized2",children:aa})}),k.jsx(c("MWXColumnItem.react"),{align:"center",children:k.jsx("div",{className:"x1l90r2v x2b8uid",children:k.jsx(c("MWXText.react"),{color:"secondary",type:"body3",children:h._("__JHASH__lzSAd4UfKCU__JHASH__")})})}),k.jsxs(c("MWXColumnItem.react"),{align:"center",children:[k.jsx(c("MWChatEncryptedBackupsNumericCodeErrorWrapper.react"),{error:K,children:k.jsx(d("FocusRegion.react").FocusRegion,{autoFocusQuery:d("focusScopeQueries").tabbableScopeQuery,id:w,children:k.jsx(c("MWChatEncryptedBackupsNumericCodeInput.react"),babelHelpers["extends"]({},X,{disabled:a||f,testid:void 0}))})}),z&&K===E()?k.jsx("div",{className:"xwib8y2",children:k.jsx(c("MWXText.react"),{align:"center",color:"negative",type:"body4",children:h._("__JHASH__47yJJ8U23lB__JHASH__")})}):null]}),f&&k.jsx(c("MWXColumnItem.react"),{align:"center",paddingVertical:0,children:k.jsxs(c("MWXRow.react"),{align:"center",paddingTop:8,spacing:8,children:[k.jsx(c("MWXRowItem.react"),{verticalAlign:"center",children:k.jsx(c("MWXSpinner.react"),{color:y?"disabled":"blue",size:12})}),k.jsx(c("MWXRowItem.react"),{verticalAlign:"center",children:k.jsx(c("MWXText.react"),{color:"secondary",testid:void 0,type:"body3",children:h._("__JHASH__G3IwntRJlbU__JHASH__")})})]})}),!f&&k.jsx(c("MWXColumnItem.react"),{align:"center",paddingTop:8,children:k.jsx(c("MWXLink.react"),{color_DEPRECATED:y?"primary":"highlight",disabled:f||a,display:"block",onClick:function(){Y(),L(),e({onFetchOtcEligibleDevicesError:function(){L(G()),c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_FETCH_OTC_ELIGIBLE_DEVICES_FAILURE"),Q()},onResendCodeFailure:function(){L(F()),c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESEND_NOTIFICATION_FAILURE")}}),c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,"OTC_RESTORE_VIEW_ALL_DEVICES_CLICK")},rel:"noreferrer",children:k.jsx(c("MWXText.react"),{color:f?"disabled":"highlight",type:"button2",children:h._("__JHASH__UdIx77e_03V__JHASH__")})})})]})})})]})}a.displayName=a.name+" [from "+f.id+"]";g["default"]=a}),226);
__d("useMWChatEncryptedBackupsAutoRestoreConsentStep",["MWChatEncryptedBackupsAutoRestoreConsentStepDeferred.react","MWChatEncryptedBackupsDismissalDialogContext","MWChatEncryptedBackupsQPLEvents","react","useLabyrinthLogging","useMWEBFlowSourceContext"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h||(h=d("react"));b=h;var j=b.useCallback,k=b.useContext;function a(){var a=k(c("MWChatEncryptedBackupsDismissalDialogContext")).setIsDismissedDisabled,b=c("useMWEBFlowSourceContext")(),e=d("useLabyrinthLogging").useLabyrinthLoggingFlow(),f=e.startFlow;return j(function(e){var g=e.onNextStep;e=e.pushPage;a(!0);f({event:d("MWChatEncryptedBackupsQPLEvents").restoreWithAutoRestoreConsentQplEvent,source:b()});e(function(){return i.jsx(c("MWChatEncryptedBackupsAutoRestoreConsentStepDeferred.react"),{onComplete:g})},{withoutBackButton:!0,withoutCloseButton:!0})},[b,a,f])}g["default"]=a}),98);