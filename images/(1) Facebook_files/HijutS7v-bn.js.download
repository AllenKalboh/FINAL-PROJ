;/*FB_PKG_DELIM*/

__d("LSUpdateAttachmentCdnUrl.nop",["ExecutionEnvironment","FBLogger","I64","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAsyncEBMediaDownloadPromise","MAWJobDefinitions","MAWTimedJob","MAWTraceUtils","MediaDownloadMediator","Promise","QPLUserFlow","WAHashStringToNumber","WAJobOrchestratorTypes","WAMediaUtils","cr:9789","err","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l="0_0_0_.enc";a=function(a,e,f,g,m,n,o){c("FBLogger")("labyrinth_web").info("LSUpdateAttachmentCdnUrl: start. traceId: %s",n);a=o!=null&&(k||(k=d("LSIntEnum"))).unwrapIntEnum(o)===c("LSMEBTaskCreationSource").MSGR_DYI;e=d("WAMediaUtils").stringToDeliveryObjectId(f);if(m!=null){if(m.includes(l)){c("FBLogger")("labyrinth_web").mustfix("LSUpdateAttachmentCdnUrl: received corrupted cdn url. traceId: %s",n);d("MAWTraceUtils").recordFailureAndFlushForTraceId(n,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],"received corrupted cdn url");return(i||(i=b("Promise"))).resolve()}c("FBLogger")("labyrinth_web").info("LSUpdateAttachmentCdnUrl: successfully got new url. traceId: %s",n);if(n!=null){g=d("WAHashStringToNumber").hashStringToNumber(n);c("QPLUserFlow").addPoint(c("qpl")._(521485815,"2166"),"update_attachment_cdn_url_nop_success",{instanceKey:g})}if(a)return d("MediaDownloadMediator").handleNewCDNUrlFromMI(e,m);g=d("MAWAsyncEBMediaDownloadPromise").retrieveMediaDownloadPayload(e);var p=[];g!=null&&c("gkx")("4663")?g.forEach(function(a){var b=a.messageId,c=a.plaintextHash;a=a.threadId;p.push(d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:f,msgId:b,plaintextHash:c,restorationCdnUrl:m,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},taskSource:(j||(j=d("I64"))).to_float(o!=null?o:(j||(j=d("I64"))).of_float(-1)),threadId:a,traceId:n}))}):p.push(d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:f,restorationCdnUrl:m,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},taskSource:(j||(j=d("I64"))).to_float(o!=null?o:(j||(j=d("I64"))).of_float(-1)),traceId:n}));if((h||(h=c("ExecutionEnvironment"))).isInWorker&&b("cr:9789")!=null){p.forEach(function(a){b("cr:9789").getJobManager().fireAndForget(a)});return(i||(i=b("Promise"))).resolve()}return(i||(i=b("Promise"))).all(p.map(function(a){return d("MAWTimedJob").TimedUIJobStarters.fireAndForget(a)})).then(function(){return(i||(i=b("Promise"))).resolve()})}g="Restoration url is empty in the response of BackupsRestoreAttachmentTask. traceId: "+((g=n)!=null?g:"null");c("FBLogger")("labyrinth_web").mustfix(g);a&&d("MediaDownloadMediator").handleMIDownloadFailure(e,c("err")(g));d("MAWTraceUtils").recordFailureAndFlushForTraceId(n,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],g);if(n!=null){a=d("WAHashStringToNumber").hashStringToNumber(n);c("QPLUserFlow").endFailure(c("qpl")._(521485815,"2166"),"no_restoration_cdn_url",{instanceKey:a})}return(i||(i=b("Promise"))).resolve()};g["default"]=a}),98);
__d("LSUpdateAttachmentCdnUrl",["LSAppendDataTraceAddon","LSIsMobileClient","LSLogMebClientEvent.nop","LSUpdateAttachmentCdnUrl.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure] Beginning execution."),c.sequence([function(d){return a[3]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),a[3],c.i64.cast([0,1830]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[9],c.i64.cast([0,3]))):c.resolve()}])},function(d){return c.nativeOperation(b("LSUpdateAttachmentCdnUrl.nop"),a[0],a[1],a[2],a[3],a[4])},function(a){return d[1]=c.i64.of_float(Date.now()),d[2]=c.i64.random(),d[4]="Finishing execution. Execution time: ",d[5]=c.i64.to_string(c.i64.sub(d[1],d[0])),d[6]=" ms",d[3]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure] ",d[3],d[4],d[3],d[5],d[3],d[6]].join("")),c.i64.eq(c.i64.mod_(d[2],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[7]=",",d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure",[d[4],d[7],d[5],d[7],d[6]].join(""),d[8],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure";e.exports=a}),null);